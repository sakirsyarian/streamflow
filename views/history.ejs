<% layout('layout') -%>
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
    <div>
      <h2 class="text-2xl font-bold tracking-tight">Stream History</h2>
      <p class="text-muted-foreground text-sm mt-1">View and manage your past streams.</p>
    </div>
    <div class="flex items-center gap-3">
      <div class="relative flex-1 md:flex-none md:w-64">
        <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm"></i>
        <input type="text" id="history-search" placeholder="Search history..." class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 pl-9 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
      </div>
      <div class="w-[180px]">
        <select id="platform-filter" class="flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
          <option value="all">All Platforms</option>
          <option value="YouTube">YouTube</option>
          <option value="Facebook">Facebook</option>
          <option value="Twitch">Twitch</option>
          <option value="TikTok">TikTok</option>
          <option value="Instagram">Instagram</option>
          <option value="Custom">Custom</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full caption-bottom text-sm">
        <thead class="[&_tr]:border-b">
          <tr class="border-b border-border transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Stream Name</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Platform</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Start Time</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Stop Time</th>
            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Duration</th>
            <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">Actions</th>
          </tr>
        </thead>
        <tbody id="history-table-body" class="[&_tr:last-child]:border-0">
          <% if (history && history.length > 0) { %>
            <% history.forEach(function(entry) { %>
              <tr class="border-b border-border transition-colors hover:bg-muted/50" data-id="<%= entry.id %>" data-platform="<%= entry.platform %>" data-title="<%= entry.title %>">
                <td class="p-4 align-middle">
                  <div class="flex items-center gap-3">
                    <div class="h-8 w-12 rounded bg-muted overflow-hidden flex-shrink-0">
                      <% if (entry.thumbnail_path) { %>
                        <img src="<%= entry.thumbnail_path %>" class="h-full w-full object-cover" onerror="this.src='/images/default-thumbnail.jpg'">
                      <% } else { %>
                        <div class="flex h-full w-full items-center justify-center bg-muted text-muted-foreground">
                          <i class="ti ti-video text-xs"></i>
                        </div>
                      <% } %>
                    </div>
                    <div class="font-medium"><%= entry.title %></div>
                  </div>
                </td>
                <td class="p-4 align-middle">
                  <div class="flex items-center gap-2">
                    <i class="ti ti-brand-<%= helpers.getPlatformIcon(entry.platform) %> text-lg" style="color: <%= helpers.getPlatformColor(entry.platform) === 'white' ? 'currentColor' : '' %>"></i>
                    <span><%= entry.platform || 'Custom' %></span>
                  </div>
                </td>
                <td class="p-4 align-middle text-muted-foreground">
                  <%= helpers.formatDateTime(entry.start_time) %>
                </td>
                <td class="p-4 align-middle text-muted-foreground">
                  <%= helpers.formatDateTime(entry.end_time) %>
                </td>
                <td class="p-4 align-middle">
                  <%= helpers.formatDuration(entry.duration) %>
                </td>
                <td class="p-4 align-middle text-right">
                  <button onclick="deleteHistoryEntry('<%= entry.id %>', '<%= entry.title %>')" class="inline-flex h-8 w-8 items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive transition-colors">
                    <i class="ti ti-trash"></i>
                  </button>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="6" class="p-8 text-center text-muted-foreground">
                <div class="flex flex-col items-center justify-center">
                  <div class="rounded-full bg-muted p-3 mb-3">
                    <i class="ti ti-history text-2xl text-muted-foreground"></i>
                  </div>
                  <p class="font-medium">No stream history found</p>
                  <p class="text-xs mt-1">Your completed streams will appear here.</p>
                </div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
     <div class="flex items-center w-full max-w-xs p-4 text-foreground bg-popover rounded-lg shadow border border-border">
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg" id="toast-icon-container">
           <i id="toast-icon" class="text-lg"></i>
        </div>
        <div class="ml-3 text-sm font-normal" id="toast-message">Message</div>
     </div>
  </div>

  <script>
    // Toast Function
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastIconContainer = document.getElementById('toast-icon-container');
      const toastIcon = document.getElementById('toast-icon');
      const toastMessage = document.getElementById('toast-message');

      toast.classList.remove('hidden');
      void toast.offsetWidth;
      toast.classList.remove('translate-y-[-20px]', 'opacity-0');

      if (type === 'success') {
        toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-green-100 text-green-500 dark:bg-green-900/30 dark:text-green-400';
        toastIcon.className = 'ti ti-check';
      } else {
        toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-red-100 text-red-500 dark:bg-red-900/30 dark:text-red-400';
        toastIcon.className = 'ti ti-alert-circle';
      }

      toastMessage.textContent = message;

      setTimeout(() => {
        toast.classList.add('translate-y-[-20px]', 'opacity-0');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 3000);
    }

    function deleteHistoryEntry(id, title) {
      if (confirm(`Are you sure you want to delete the history entry for "${title}"?`)) {
        fetch(`/api/history/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('Entry deleted');
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
               row.style.opacity = '0';
               setTimeout(() => {
                  row.remove();
                  const tbody = document.getElementById('history-table-body');
                  if(!tbody.children.length) location.reload();
               }, 300);
            }
          } else {
            showToast(data.error || 'Failed to delete', 'error');
          }
        })
        .catch(e => showToast('Error deleting entry', 'error'));
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('history-search');
      const platformFilter = document.getElementById('platform-filter');

      function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const platform = platformFilter.value;
        const rows = document.querySelectorAll('#history-table-body tr');

        let visibleCount = 0;

        rows.forEach(row => {
          if (row.querySelector('td[colspan]')) return; // Skip empty state row

          const title = row.getAttribute('data-title')?.toLowerCase() || '';
          const rowPlatform = row.getAttribute('data-platform');

          const matchesSearch = !searchTerm || title.includes(searchTerm);
          const matchesPlatform = platform === 'all' || rowPlatform === platform;

          if (matchesSearch && matchesPlatform) {
             row.style.display = '';
             visibleCount++;
          } else {
             row.style.display = 'none';
          }
        });

        // Handle empty search result
        const existingEmpty = document.getElementById('empty-search-results');
        if (visibleCount === 0 && !existingEmpty) {
           const tbody = document.getElementById('history-table-body');
           // Check if it's not the initial empty state
           if (!tbody.querySelector('td[colspan]')) {
              const tr = document.createElement('tr');
              tr.id = 'empty-search-results';
              tr.innerHTML = `
                 <td colspan="6" class="p-8 text-center text-muted-foreground">
                    <p>No matching results found</p>
                 </td>
              `;
              tbody.appendChild(tr);
           }
        } else if (visibleCount > 0 && existingEmpty) {
           existingEmpty.remove();
        }
      }

      searchInput.addEventListener('input', filterTable);
      platformFilter.addEventListener('change', filterTable);
    });
  </script>
