<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - StreamFlow</title>
  <link rel="icon" href="/images/logo.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.30.0/tabler-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>

  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 240 10% 3.9%;
      --card: 0 0% 100%;
      --card-foreground: 240 10% 3.9%;
      --popover: 0 0% 100%;
      --popover-foreground: 240 10% 3.9%;
      --primary: 240 5.9% 10%;
      --primary-foreground: 0 0% 98%;
      --secondary: 240 4.8% 95.9%;
      --secondary-foreground: 240 5.9% 10%;
      --muted: 240 4.8% 95.9%;
      --muted-foreground: 240 3.8% 46.1%;
      --accent: 240 4.8% 95.9%;
      --accent-foreground: 240 5.9% 10%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 0 0% 98%;
      --border: 240 5.9% 90%;
      --input: 240 5.9% 90%;
      --ring: 240 10% 3.9%;
      --radius: 0.5rem;
    }

    .dark {
      --background: 240 10% 3.9%;
      --foreground: 0 0% 98%;
      --card: 240 10% 3.9%;
      --card-foreground: 0 0% 98%;
      --popover: 240 10% 3.9%;
      --popover-foreground: 0 0% 98%;
      --primary: 0 0% 98%;
      --primary-foreground: 240 5.9% 10%;
      --secondary: 240 3.7% 15.9%;
      --secondary-foreground: 0 0% 98%;
      --muted: 240 3.7% 15.9%;
      --muted-foreground: 240 5% 64.9%;
      --accent: 240 3.7% 15.9%;
      --accent-foreground: 0 0% 98%;
      --destructive: 0 62.8% 30.6%;
      --destructive-foreground: 0 0% 98%;
      --border: 240 3.7% 15.9%;
      --input: 240 3.7% 15.9%;
      --ring: 240 4.9% 83.9%;
    }
  </style>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        container: {
          center: true,
          padding: "2rem",
          screens: {
            "2xl": "1400px",
          },
        },
        extend: {
          colors: {
            border: "hsl(var(--border))",
            input: "hsl(var(--input))",
            ring: "hsl(var(--ring))",
            background: "hsl(var(--background))",
            foreground: "hsl(var(--foreground))",
            primary: {
              DEFAULT: "hsl(var(--primary))",
              foreground: "hsl(var(--primary-foreground))",
            },
            secondary: {
              DEFAULT: "hsl(var(--secondary))",
              foreground: "hsl(var(--secondary-foreground))",
            },
            destructive: {
              DEFAULT: "hsl(var(--destructive))",
              foreground: "hsl(var(--destructive-foreground))",
            },
            muted: {
              DEFAULT: "hsl(var(--muted))",
              foreground: "hsl(var(--muted-foreground))",
            },
            accent: {
              DEFAULT: "hsl(var(--accent))",
              foreground: "hsl(var(--accent-foreground))",
            },
            popover: {
              DEFAULT: "hsl(var(--popover))",
              foreground: "hsl(var(--popover-foreground))",
            },
            card: {
              DEFAULT: "hsl(var(--card))",
              foreground: "hsl(var(--card-foreground))",
            },
          },
          borderRadius: {
            lg: "var(--radius)",
            md: "calc(var(--radius) - 2px)",
            sm: "calc(var(--radius) - 4px)",
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
        }
      }
    }
  </script>
  <script src="/js/stream-modal.js" defer></script>
</head>
<body class="bg-background text-foreground font-sans antialiased min-h-screen flex flex-col md:flex-row">

  <!-- Mobile Header -->
  <header class="md:hidden h-16 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50 flex items-center justify-between px-4">
    <div class="flex items-center gap-2 font-bold text-lg">
      <img src="/images/logo_mobile.svg" alt="Logo" class="h-6 w-auto">
      <span>StreamFlow</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="mobile-menu-btn" class="p-2 hover:bg-accent rounded-md">
        <i class="ti ti-menu-2 text-xl"></i>
      </button>
    </div>
  </header>

  <!-- Sidebar / Navigation -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-card border-r border-border transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out md:static md:block flex flex-col h-screen">
    <div class="h-16 flex items-center px-6 border-b border-border">
      <a href="/" class="flex items-center gap-2 font-bold text-xl">
        <img src="/images/logo.svg" alt="Logo" class="h-8 w-8">
        <span>StreamFlow</span>
      </a>
    </div>

    <div class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
      <a href="/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors <%= active === 'dashboard' ? 'bg-secondary text-foreground' : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground' %>">
        <i class="ti ti-broadcast text-lg"></i>
        Streams
      </a>
      <a href="/gallery" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors <%= active === 'gallery' ? 'bg-secondary text-foreground' : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground' %>">
        <i class="ti ti-video text-lg"></i>
        Gallery
      </a>
      <a href="/playlist" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors <%= active === 'playlist' ? 'bg-secondary text-foreground' : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground' %>">
        <i class="ti ti-playlist text-lg"></i>
        Playlist
      </a>
      <a href="/history" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors <%= active === 'history' ? 'bg-secondary text-foreground' : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground' %>">
        <i class="ti ti-history text-lg"></i>
        History
      </a>

      <% if (req.session && req.session.user_role === 'admin') { %>
        <div class="pt-4 pb-2">
          <p class="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider">Admin</p>
        </div>
        <a href="/users" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors <%= active === 'users' ? 'bg-secondary text-foreground' : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground' %>">
          <i class="ti ti-users text-lg"></i>
          Users
        </a>
      <% } %>
    </div>

    <div class="p-4 border-t border-border">
      <div class="relative">
        <button id="user-menu-btn" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-accent transition-colors text-left">
          <div class="h-8 w-8 rounded-full overflow-hidden bg-secondary">
            <%- helpers.getAvatar(req) %>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium truncate"><%= helpers.getUsername(req) %></p>
            <p class="text-xs text-muted-foreground truncate"><%= req.session.email || 'User' %></p>
          </div>
          <i class="ti ti-chevron-up text-muted-foreground"></i>
        </button>

        <!-- User Dropdown -->
        <div id="user-dropdown" class="absolute bottom-full left-0 w-full mb-2 bg-popover border border-border rounded-md shadow-lg hidden">
          <div class="p-1">
            <a href="/settings" class="flex items-center gap-2 px-3 py-2 text-sm rounded-sm hover:bg-accent hover:text-accent-foreground">
              <i class="ti ti-settings text-muted-foreground"></i>
              Settings
            </a>
            <button id="theme-toggle" class="w-full flex items-center gap-2 px-3 py-2 text-sm rounded-sm hover:bg-accent hover:text-accent-foreground text-left">
                <i class="ti ti-moon text-muted-foreground" id="theme-icon"></i>
                <span id="theme-text">Dark Mode</span>
            </button>
            <a href="https://github.com/bangtutorial/streamflow/issues" target="_blank" class="flex items-center gap-2 px-3 py-2 text-sm rounded-sm hover:bg-accent hover:text-accent-foreground">
              <i class="ti ti-help text-muted-foreground"></i>
              Help & Support
            </a>
            <div class="h-px bg-border my-1"></div>
            <a href="/logout" class="flex items-center gap-2 px-3 py-2 text-sm rounded-sm text-destructive hover:bg-destructive/10">
              <i class="ti ti-logout"></i>
              Log out
            </a>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col min-h-screen overflow-hidden bg-background">
    <!-- Top Bar (Desktop) -->
    <header class="hidden md:flex h-16 items-center justify-between border-b border-border px-6">
      <div class="flex items-center gap-4">
        <!-- Breadcrumb or Page Title can go here -->
        <h1 class="text-lg font-semibold"><%= title %></h1>
      </div>
      <div class="flex items-center gap-4">
        <a href="https://github.com/bangtutorial/streamflow" target="_blank" class="text-muted-foreground hover:text-foreground transition-colors">
          <i class="ti ti-brand-github text-xl"></i>
        </a>
        <div class="relative">
          <button id="notification-btn" class="text-muted-foreground hover:text-foreground transition-colors relative">
            <i class="ti ti-bell text-xl"></i>
            <span class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-destructive rounded-full border-2 border-background"></span>
          </button>

          <!-- Notification Dropdown -->
          <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-popover border border-border rounded-md shadow-lg z-50 hidden">
            <div class="p-4 border-b border-border">
              <h3 class="font-medium text-sm">Notifications</h3>
            </div>
            <div class="max-h-80 overflow-y-auto" id="notification-list">
              <!-- Notifications will be injected here -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="flex-1 overflow-auto p-4 md:p-6 lg:p-8">
      <%- body %>

      <!-- Footer -->
      <footer class="mt-8 pt-8 border-t border-border flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-muted-foreground">
        <div class="flex items-center gap-2">
          <span>StreamFlow</span>
          <span class="bg-secondary px-1.5 py-0.5 rounded text-xs font-medium">v2.1</span>
        </div>
        <div class="flex items-center gap-4">
          <a href="https://youtube.com/@bangtutorial" target="_blank" class="hover:text-foreground">by Bang Tutorial</a>
          <div class="h-3 w-px bg-border"></div>
          <a href="https://donate.youtube101.id/" target="_blank" class="flex items-center gap-1 hover:text-foreground">
            <i class="ti ti-heart"></i>
            Donate
          </a>
        </div>
      </footer>
    </div>
  </main>

  <!-- Mobile Overlay -->
  <div id="mobile-overlay" class="fixed inset-0 bg-background/80 backdrop-blur-sm z-40 hidden md:hidden"></div>

  <!-- Update Modal -->
  <div id="streamflowUpdateModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
    <div class="bg-card border border-border rounded-lg shadow-lg w-full max-w-lg max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-border">
        <h3 class="text-lg font-semibold">Update StreamFlow v2</h3>
        <button onclick="closeStreamflowUpdateModal()" class="text-muted-foreground hover:text-foreground">
          <i class="ti ti-x text-lg"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto space-y-4">
        <p class="text-muted-foreground">Terima kasih buat teman-teman yang sudah menunggu. Berikut adalah update terbaru yang ada di StreamFlow v2:</p>
        
        <div class="space-y-4">
          <div class="flex gap-3">
            <div class="mt-0.5 w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center shrink-0">
              <i class="ti ti-layout-dashboard text-blue-500"></i>
            </div>
            <div>
              <h4 class="font-medium text-sm">UI Baru yang Lebih Fresh</h4>
              <p class="text-sm text-muted-foreground">Tampilan baru yang lebih fresh dan user freindly.</p>
            </div>
          </div>
          
           <div class="flex gap-3">
            <div class="mt-0.5 w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center shrink-0">
              <i class="ti ti-rocket text-green-500"></i>
            </div>
            <div>
              <h4 class="font-medium text-sm">Live Streaming Lebih Ringan</h4>
              <p class="text-sm text-muted-foreground">Optimasi proses streaming untuk performa yang lebih baik.</p>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="mt-0.5 w-8 h-8 rounded-full bg-purple-500/10 flex items-center justify-center shrink-0">
              <i class="ti ti-calendar text-purple-500"></i>
            </div>
            <div>
              <h4 class="font-medium text-sm">Penjadwalan Live Streaming</h4>
              <p class="text-sm text-muted-foreground">Fitur penjadwalan dan auto stop yang diperbaiki.</p>
            </div>
          </div>
          
           <div class="flex gap-3">
            <div class="mt-0.5 w-8 h-8 rounded-full bg-amber-500/10 flex items-center justify-center shrink-0">
              <i class="ti ti-bug text-amber-500"></i>
            </div>
            <div>
              <h4 class="font-medium text-sm">Fix Bug</h4>
              <p class="text-sm text-muted-foreground">Perbaikan bug streaming terhenti dan stabilitas lainnya.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme Management
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    const htmlElement = document.documentElement;

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            htmlElement.classList.add('dark');
            updateThemeUI(true);
        } else {
            htmlElement.classList.remove('dark');
            updateThemeUI(false);
        }
    }

    function updateThemeUI(isDark) {
        if (isDark) {
            themeIcon.className = 'ti ti-sun text-muted-foreground';
            themeText.textContent = 'Light Mode';
        } else {
            themeIcon.className = 'ti ti-moon text-muted-foreground';
            themeText.textContent = 'Dark Mode';
        }
    }

    if (themeToggle) {
        themeToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent dropdown close
            const isDark = htmlElement.classList.contains('dark');
            if (isDark) {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                updateThemeUI(false);
            } else {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                updateThemeUI(true);
            }
        });
    }

    initTheme();

    // Sidebar Toggle
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');

    function toggleSidebar() {
      const isClosed = sidebar.classList.contains('-translate-x-full');
      if (isClosed) {
        sidebar.classList.remove('-translate-x-full');
        mobileOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } else {
        sidebar.classList.add('-translate-x-full');
        mobileOverlay.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', toggleSidebar);
    }

    if (mobileOverlay) {
      mobileOverlay.addEventListener('click', toggleSidebar);
    }

    // User Dropdown
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userDropdown = document.getElementById('user-dropdown');

    if (userMenuBtn && userDropdown) {
      userMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.add('hidden');
        }
      });
    }

    // Notification Dropdown
    const notificationBtn = document.getElementById('notification-btn');
    const notificationDropdown = document.getElementById('notification-dropdown');

    if (notificationBtn && notificationDropdown) {
      notificationBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        notificationDropdown.classList.toggle('hidden');
        hideNotificationBadge();
      });

      document.addEventListener('click', (e) => {
        if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
          notificationDropdown.classList.add('hidden');
        }
      });
    }

    // Notification Logic (re-using existing logic logic but adapted)
    function hideNotificationBadge() {
      const badge = document.querySelector('#notification-btn span');
      if (badge) badge.classList.add('hidden');
      
      const latestCommitSha = localStorage.getItem('latestCommitSha');
      if (latestCommitSha) {
        localStorage.setItem('savedCommitSha', latestCommitSha);
      }
    }

    async function checkGitHubUpdates() {
      try {
        const response = await fetch('https://api.github.com/repos/bangtutorial/streamflow/commits?per_page=3');
        if (!response.ok) return;
        
        const commits = await response.json();
        if (commits && commits.length > 0) {
          const latestCommitSha = commits[0].sha;
          const savedCommitSha = localStorage.getItem('savedCommitSha');

          localStorage.setItem('latestCommitSha', latestCommitSha);
          renderNotifications(commits);

          if (!savedCommitSha || savedCommitSha !== latestCommitSha) {
            const badge = document.querySelector('#notification-btn span');
            if (badge) badge.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Failed to fetch updates', error);
      }
    }

    function renderNotifications(commits) {
      const list = document.getElementById('notification-list');
      if (!list) return;
      list.innerHTML = '';
      
      commits.forEach(commit => {
         const timeAgo = getTimeAgo(commit.commit.author.date);
         const item = document.createElement('div');
         item.className = 'p-3 hover:bg-accent cursor-pointer border-b border-border last:border-0';
         item.onclick = () => window.open(commit.html_url, '_blank');
         item.innerHTML = `
            <div class="flex items-start gap-3">
              <img src="${commit.author ? commit.author.avatar_url : 'https://github.com/github.png'}" class="w-8 h-8 rounded-full">
              <div>
                <p class="text-sm font-medium leading-none mb-1">Update Available</p>
                <p class="text-xs text-muted-foreground line-clamp-2">${commit.commit.message}</p>
                <p class="text-[10px] text-muted-foreground mt-1">${timeAgo}</p>
              </div>
            </div>
         `;
         list.appendChild(item);
      });
    }

    function getTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'Just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    }

    document.addEventListener('DOMContentLoaded', checkGitHubUpdates);

    // Modal helpers
    function openStreamflowUpdateModal() {
      const modal = document.getElementById('streamflowUpdateModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeStreamflowUpdateModal() {
      const modal = document.getElementById('streamflowUpdateModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
      }
    }

    window.closeStreamflowUpdateModal = closeStreamflowUpdateModal;
  </script>
</body>
</html>
