<% layout('layout') -%>
  
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
    <div>
      <h2 class="text-2xl font-bold tracking-tight">Settings</h2>
      <p class="text-muted-foreground text-sm mt-1">Manage your account settings and preferences.</p>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Sidebar Navigation -->
    <div class="lg:col-span-1">
       <div class="flex flex-col space-y-1 rounded-lg border border-border bg-card p-1 shadow-sm">
         <button class="settings-tab active flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md transition-colors text-primary bg-secondary"
           data-tab="profile">
           <i class="ti ti-user"></i>
           Profile
         </button>
         <button class="settings-tab flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md transition-colors text-muted-foreground hover:bg-accent hover:text-accent-foreground"
           data-tab="security">
           <i class="ti ti-shield-lock"></i>
           Security
         </button>
       </div>
    </div>

    <!-- Main Content -->
    <div class="lg:col-span-3">
      <div class="rounded-xl border border-border bg-card text-card-foreground shadow-sm">

        <!-- Profile Tab -->
        <div id="profile-tab" class="settings-content">
          <div class="p-6 space-y-6">
            <div>
               <h3 class="text-lg font-semibold">Profile</h3>
               <p class="text-sm text-muted-foreground">Update your photo and personal details.</p>
            </div>

            <div class="border-t border-border my-4"></div>

            <form id="profile-form" class="space-y-8" action="/settings/profile" method="post" enctype="multipart/form-data">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="hidden" name="activeTab" value="profile">

              <div class="flex flex-col sm:flex-row gap-8">
                <div class="flex-shrink-0">
                   <label class="block text-sm font-medium mb-3">Profile Photo</label>
                   <div class="relative group">
                      <div class="h-24 w-24 rounded-full overflow-hidden border-2 border-muted bg-muted">
                         <img id="profile-preview" src="<%= user.avatar_path || '/images/default-avatar.jpg' %>" class="h-full w-full object-cover" onerror="this.src='/images/default-avatar.jpg'">
                      </div>
                      <label for="profile-upload" class="absolute bottom-0 right-0 rounded-full bg-primary p-1.5 shadow-sm cursor-pointer hover:bg-primary/90 transition-colors ring-2 ring-background">
                         <i class="ti ti-camera text-primary-foreground text-xs"></i>
                      </label>
                      <input id="profile-upload" name="avatar" type="file" accept="image/*" class="hidden">
                   </div>
                   <p class="mt-2 text-xs text-muted-foreground text-center sm:text-left max-w-[100px]">
                     Max size 2MB
                   </p>
                </div>

                <div class="flex-1 space-y-4 max-w-md">
                   <div class="space-y-2">
                      <label for="username" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Username</label>
                      <input type="text" id="username" name="username" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" value="<%= user.username %>">
                      <p class="text-[0.8rem] text-muted-foreground">This is your public display name.</p>
                   </div>
                </div>
              </div>

              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Security Tab -->
        <div id="security-tab" class="settings-content hidden">
          <div class="p-6 space-y-6">
             <div>
               <h3 class="text-lg font-semibold">Security</h3>
               <p class="text-sm text-muted-foreground">Manage your password and account security.</p>
            </div>

            <div class="border-t border-border my-4"></div>

            <form id="password-form" class="space-y-6 max-w-md" action="/settings/password" method="post">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="hidden" name="activeTab" value="security">

              <div class="space-y-2">
                <label for="current-password" class="text-sm font-medium leading-none">Current Password</label>
                <input type="password" id="current-password" name="currentPassword" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" placeholder="Enter current password">
              </div>

              <div class="space-y-2">
                <label for="new-password" class="text-sm font-medium leading-none">New Password</label>
                <div class="relative">
                   <input type="password" id="new-password" name="newPassword" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pr-10 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" placeholder="Enter new password">
                   <button type="button" id="toggle-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
                      <i class="ti ti-eye"></i>
                   </button>
                </div>
                <p class="text-[0.8rem] text-muted-foreground">Min. 8 chars, including upper/lowercase & number.</p>
              </div>

              <div class="space-y-2">
                <label for="confirm-password" class="text-sm font-medium leading-none">Confirm New Password</label>
                <input type="password" id="confirm-password" name="confirmPassword" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" placeholder="Confirm new password">
              </div>

              <div class="flex justify-end pt-4">
                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                  Update Password
                </button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
     <div class="flex items-center w-full max-w-xs p-4 text-foreground bg-popover rounded-lg shadow border border-border" role="alert">
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg" id="toast-icon-container">
           <i id="toast-icon" class="text-lg"></i>
        </div>
        <div class="ml-3 text-sm font-normal" id="toast-message">Message content</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-popover text-muted-foreground hover:text-foreground rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-accent inline-flex items-center justify-center h-8 w-8" onclick="hideToast()">
           <span class="sr-only">Close</span>
           <i class="ti ti-x"></i>
        </button>
     </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Tabs
      const tabs = document.querySelectorAll('.settings-tab');
      const tabContents = document.querySelectorAll('.settings-content');

      function activateTab(tabName) {
        tabs.forEach(tab => {
           tab.classList.remove('active', 'text-primary', 'bg-secondary');
           tab.classList.add('text-muted-foreground', 'hover:bg-accent', 'hover:text-accent-foreground');
        });

        tabContents.forEach(content => content.classList.add('hidden'));

        const selectedTab = document.querySelector(`.settings-tab[data-tab="${tabName}"]`);
        if (selectedTab) {
          selectedTab.classList.add('active', 'text-primary', 'bg-secondary');
          selectedTab.classList.remove('text-muted-foreground', 'hover:bg-accent', 'hover:text-accent-foreground');

          const selectedContent = document.getElementById(`${tabName}-tab`);
          if (selectedContent) {
            selectedContent.classList.remove('hidden');
          }
        }
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          activateTab(tabName);
        });
      });

      // Initial Tab
      <% if (typeof activeTab !== 'undefined' && activeTab) { %>
          activateTab('<%= activeTab %>');
      <% } else { %>
          activateTab('profile');
      <% } %>

      // Image Upload Preview
      const profileUpload = document.getElementById('profile-upload');
      const profilePreview = document.getElementById('profile-preview');

      profileUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 2 * 1024 * 1024) {
            showToast('error', 'Image too large. Maximum size is 2MB.');
            return;
          }
          const reader = new FileReader();
          reader.onload = function (event) {
            profilePreview.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Form Validations
      const profileForm = document.getElementById('profile-form');
      profileForm.addEventListener('submit', (e) => {
        const fileInput = document.getElementById('profile-upload');
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          if (file.size > 2 * 1024 * 1024) {
            e.preventDefault();
            showToast('error', 'Image too large. Maximum size is 2MB.');
            return false;
          }
        }
      });

      const passwordForm = document.getElementById('password-form');
      passwordForm.addEventListener('submit', (e) => {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!currentPassword) {
          e.preventDefault();
          showToast('error', 'Please enter your current password.');
          return false;
        }
        if (!newPassword) {
          e.preventDefault();
          showToast('error', 'Please enter a new password.');
          return false;
        }
        if (newPassword !== confirmPassword) {
          e.preventDefault();
          showToast('error', 'New passwords do not match.');
          return false;
        }
      });

      // Password Toggle
      const togglePassword = document.getElementById('toggle-password');
      const newPasswordField = document.getElementById('new-password');

      togglePassword.addEventListener('click', () => {
        const type = newPasswordField.getAttribute('type') === 'password' ? 'text' : 'password';
        newPasswordField.setAttribute('type', type);

        const icon = togglePassword.querySelector('i');
        if (type === 'password') {
           icon.classList.remove('ti-eye-off');
           icon.classList.add('ti-eye');
        } else {
           icon.classList.remove('ti-eye');
           icon.classList.add('ti-eye-off');
        }
      });

      // Toast Logic
      window.showToast = function(type, message) {
        const toast = document.getElementById('toast');
        const toastIconContainer = document.getElementById('toast-icon-container');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');

        toast.classList.remove('hidden');
        // Trigger reflow
        void toast.offsetWidth;
        toast.classList.remove('translate-y-[-20px]', 'opacity-0');

        if (type === 'success') {
          toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-green-100 text-green-500 dark:bg-green-800 dark:text-green-200';
          toastIcon.className = 'ti ti-check';
        } else {
          toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-red-100 text-red-500 dark:bg-red-800 dark:text-red-200';
          toastIcon.className = 'ti ti-x';
        }

        toastMessage.textContent = message;

        setTimeout(() => {
          hideToast();
        }, 4000);
      }

      window.hideToast = function() {
         const toast = document.getElementById('toast');
         toast.classList.add('translate-y-[-20px]', 'opacity-0');
         setTimeout(() => {
            toast.classList.add('hidden');
         }, 300);
      }

      <% if (typeof success !== 'undefined' && success) { %>
          showToast('success', '<%= success %>');
      <% } %>
      <% if (typeof error !== 'undefined' && error) { %>
          showToast('error', '<%= error %>');
      <% } %>
    });
  </script>
