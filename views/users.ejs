<% layout('layout') -%>

<div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
  <div>
    <h2 class="text-2xl font-bold tracking-tight">User Management</h2>
    <p class="text-muted-foreground text-sm mt-1">Manage user accounts and permissions.</p>
  </div>
  <div>
    <button onclick="openCreateModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
      <i class="ti ti-plus mr-2"></i>
      Create New User
    </button>
  </div>
</div>

<div class="rounded-lg border border-border bg-card p-4 mb-8 shadow-sm">
  <div class="flex flex-col sm:flex-row items-center gap-4">
    <div class="relative flex-1 w-full">
       <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm"></i>
       <input type="text" id="searchInput" placeholder="Search users..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-9 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
    </div>
    <div class="w-full sm:w-[150px]">
      <select id="roleFilter" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="member">Member</option>
      </select>
    </div>
    <div class="w-full sm:w-[150px]">
      <select id="statusFilter" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
  </div>
</div>

<div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full caption-bottom text-sm">
      <thead class="[&_tr]:border-b">
        <tr class="border-b border-border transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">User</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Role</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Status</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Video</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Streaming</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Created</th>
          <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody" class="[&_tr:last-child]:border-0">
        <% if (users && users.length > 0) { %>
          <% users.forEach(function(user) { %>
            <tr class="border-b border-border transition-colors hover:bg-muted/50 user-row"
                data-username="<%= user.username.toLowerCase() %>" 
                data-role="<%= user.user_role %>" 
                data-status="<%= user.status %>">
              <td class="p-4 align-middle">
                <div class="flex items-center gap-3">
                  <div class="relative h-10 w-10 rounded-full overflow-hidden bg-muted">
                    <% if (user.avatar_path) { %>
                      <img src="<%= user.avatar_path %>" alt="<%= user.username %>" class="h-full w-full object-cover" onerror="this.src='/images/default-avatar.jpg'">
                    <% } else { %>
                      <img src="/images/default-avatar.jpg" alt="Default" class="h-full w-full object-cover">
                    <% } %>
                  </div>
                  <div>
                    <div class="font-medium"><%= user.username %></div>
                    <div class="text-xs text-muted-foreground">ID: <%= user.id %></div>
                  </div>
                </div>
              </td>
              <td class="p-4 align-middle">
                <span class="inline-flex items-center rounded-full border border-transparent px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 <%= user.user_role === 'admin' ? 'bg-purple-500/10 text-purple-500' : 'bg-blue-500/10 text-blue-500' %>">
                  <%= user.user_role %>
                </span>
              </td>
              <td class="p-4 align-middle">
                <span class="inline-flex items-center rounded-full border border-transparent px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 <%= user.status === 'active' ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500' %>">
                  <%= user.status %>
                </span>
              </td>
              <td class="p-4 align-middle cursor-pointer hover:text-primary transition-colors" onclick="showVideoModal(this)" data-user-id="<%= user.id %>" data-username="<%= user.username %>">
                <div class="flex flex-col gap-1">
                  <div class="flex items-center text-sm">
                    <i class="ti ti-video mr-1.5"></i>
                    <span><%= user.videoCount || 0 %> video</span>
                  </div>
                  <span class="inline-flex w-fit items-center rounded-sm bg-secondary px-1.5 py-0.5 text-xs font-medium text-secondary-foreground">
                    <%= user.totalVideoSize || '0 B' %>
                  </span>
                </div>
              </td>
              <td class="p-4 align-middle cursor-pointer hover:text-primary transition-colors" onclick="showStreamModal(this)" data-user-id="<%= user.id %>" data-username="<%= user.username %>">
                <div class="flex flex-col gap-1">
                  <div class="flex items-center text-sm">
                    <i class="ti ti-broadcast mr-1.5"></i>
                    <span><%= user.streamCount || 0 %> stream</span>
                  </div>
                  <span class="inline-flex w-fit items-center rounded-sm bg-secondary px-1.5 py-0.5 text-xs font-medium text-secondary-foreground">
                    <%= user.activeStreamCount || 0 %> online
                  </span>
                </div>
              </td>
              <td class="p-4 align-middle text-muted-foreground">
                <%= new Date(user.created_at).toLocaleDateString() %>
              </td>
              <td class="p-4 align-middle">
                <div class="flex items-center gap-2">
                  <button onclick="editUser('<%= user.id %>', '<%= user.username %>', '<%= user.user_role %>', '<%= user.status %>', '<%= user.avatar_path || '' %>')" class="inline-flex h-8 w-8 items-center justify-center rounded-md hover:bg-accent hover:text-accent-foreground transition-colors">
                    <i class="ti ti-edit text-sm"></i>
                  </button>
                  <% if (user.id !== req.session.userId) { %>
                    <button onclick="deleteUser('<%= user.id %>', '<%= user.username %>')" class="inline-flex h-8 w-8 items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive transition-colors">
                      <i class="ti ti-trash text-sm"></i>
                    </button>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr id="defaultEmptyState">
            <td colspan="7" class="p-8 text-center text-muted-foreground">
              <div class="flex flex-col items-center justify-center">
                <div class="rounded-full bg-muted p-3 mb-3">
                  <i class="ti ti-users text-2xl text-muted-foreground"></i>
                </div>
                <p class="font-medium">No users found</p>
              </div>
            </td>
          </tr>
        <% } %>
        <tr id="searchEmptyState" class="hidden">
          <td colspan="7" class="p-8 text-center text-muted-foreground">
            <p class="font-medium">No users match your search criteria</p>
            <p class="text-xs mt-1">Try adjusting your filters or search terms</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm hidden flex items-center justify-center p-4 sm:p-6">
  <div id="editModalContent" class="fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-background p-6 shadow-lg duration-200 sm:rounded-lg">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold leading-none tracking-tight">Edit User</h3>
      <button onclick="closeEditModal()" class="rounded-full p-1 hover:bg-accent hover:text-accent-foreground transition-colors">
        <i class="ti ti-x text-lg"></i>
      </button>
    </div>

    <form id="editUserForm" enctype="multipart/form-data" class="space-y-4 mt-2">
      <input type="hidden" id="editUserId" name="userId">

      <div class="flex items-center gap-4">
        <div class="relative h-16 w-16 rounded-full overflow-hidden bg-muted border border-border">
          <img id="editUserAvatar" src="/images/default-avatar.jpg" class="h-full w-full object-cover">
        </div>
        <div>
          <input type="file" id="editAvatarInput" name="avatar" accept="image/*" class="hidden">
          <button type="button" onclick="document.getElementById('editAvatarInput').click()" class="inline-flex items-center justify-center rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 px-3">
            Change Photo
          </button>
        </div>
      </div>

      <div class="space-y-2">
        <label for="editUsername" class="text-sm font-medium leading-none">Username</label>
        <input type="text" id="editUsername" name="username" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <label for="editRole" class="text-sm font-medium leading-none">Role</label>
          <select id="editRole" name="role" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            <option value="member">Member</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="space-y-2">
          <label for="editStatus" class="text-sm font-medium leading-none">Status</label>
          <select id="editStatus" name="status" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="space-y-2">
        <label for="editPassword" class="text-sm font-medium leading-none">New Password (Optional)</label>
        <input type="password" id="editPassword" name="password" placeholder="Leave empty to keep current" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
      </div>
      
      <div class="flex justify-end gap-3 pt-4 border-t border-border">
        <button type="button" onclick="closeEditModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">Cancel</button>
        <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Create Modal (Similar structure) -->
<div id="createModal" class="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm hidden flex items-center justify-center p-4 sm:p-6">
  <div id="createModalContent" class="fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-background p-6 shadow-lg duration-200 sm:rounded-lg">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold leading-none tracking-tight">Create New User</h3>
      <button onclick="closeCreateModal()" class="rounded-full p-1 hover:bg-accent hover:text-accent-foreground transition-colors">
        <i class="ti ti-x text-lg"></i>
      </button>
    </div>

    <form id="createUserForm" enctype="multipart/form-data" class="space-y-4 mt-2">
      <div class="flex items-center gap-4">
        <div class="relative h-16 w-16 rounded-full overflow-hidden bg-muted border border-border">
          <img id="createUserAvatar" src="/images/default-avatar.jpg" class="h-full w-full object-cover">
        </div>
        <div>
          <input type="file" id="createAvatarInput" name="avatar" accept="image/*" class="hidden">
          <button type="button" onclick="document.getElementById('createAvatarInput').click()" class="inline-flex items-center justify-center rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 px-3">
            Choose Photo
          </button>
        </div>
      </div>

      <div class="space-y-2">
        <label for="createUsername" class="text-sm font-medium leading-none">Username</label>
        <input type="text" id="createUsername" name="username" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <label for="createRole" class="text-sm font-medium leading-none">Role</label>
          <select id="createRole" name="role" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            <option value="member">Member</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="space-y-2">
          <label for="createStatus" class="text-sm font-medium leading-none">Status</label>
          <select id="createStatus" name="status" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="space-y-2">
        <label for="createPassword" class="text-sm font-medium leading-none">Password</label>
        <input type="password" id="createPassword" name="password" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
      </div>
      
      <div class="flex justify-end gap-3 pt-4 border-t border-border">
        <button type="button" onclick="closeCreateModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">Cancel</button>
        <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Create User</button>
      </div>
    </form>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm hidden flex items-center justify-center p-4 sm:p-6">
  <div class="fixed left-[50%] top-[50%] z-50 grid w-full max-w-md translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-background p-6 shadow-lg duration-200 sm:rounded-lg">
    <div class="flex flex-col space-y-2 text-center sm:text-left">
      <h3 class="text-lg font-semibold leading-none tracking-tight" id="modalTitle">Confirm Action</h3>
      <p class="text-sm text-muted-foreground" id="modalMessage">Are you sure?</p>
    </div>
    <div class="flex justify-end gap-3 mt-4">
      <button onclick="closeModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
      <button id="confirmButton" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-9 px-4 py-2">Confirm</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
   <div class="flex items-center w-full max-w-xs p-4 text-foreground bg-popover rounded-lg shadow border border-border">
      <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg" id="toast-icon-container">
         <i id="toast-icon" class="text-lg"></i>
      </div>
      <div class="ml-3 text-sm font-normal" id="toast-message">Message</div>
   </div>
</div>

<!-- Video/Stream Collection Modals (Using default centered layout) -->
<div id="videoModal" class="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm hidden flex items-center justify-center p-4 sm:p-6">
   <div class="fixed left-[50%] top-[50%] z-50 grid w-full max-w-2xl translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-background p-6 shadow-lg duration-200 sm:rounded-lg max-h-[80vh] flex flex-col">
      <div class="flex items-center justify-between pb-4 border-b border-border">
         <h3 class="text-lg font-semibold" id="videoModalTitle">User Videos</h3>
         <button onclick="closeVideoModal()" class="rounded-full p-1 hover:bg-accent hover:text-accent-foreground"><i class="ti ti-x"></i></button>
      </div>
      <div id="videoList" class="overflow-y-auto flex-1 space-y-3 pr-1"></div>
      <div id="videoEmptyState" class="hidden py-8 text-center text-muted-foreground"><p>No videos found</p></div>
   </div>
</div>

<div id="streamModal" class="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm hidden flex items-center justify-center p-4 sm:p-6">
   <div class="fixed left-[50%] top-[50%] z-50 grid w-full max-w-2xl translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-background p-6 shadow-lg duration-200 sm:rounded-lg max-h-[80vh] flex flex-col">
      <div class="flex items-center justify-between pb-4 border-b border-border">
         <h3 class="text-lg font-semibold" id="streamModalTitle">User Streams</h3>
         <button onclick="closeStreamModal()" class="rounded-full p-1 hover:bg-accent hover:text-accent-foreground"><i class="ti ti-x"></i></button>
      </div>
      <div id="streamList" class="overflow-y-auto flex-1 space-y-3 pr-1"></div>
      <div id="streamEmptyState" class="hidden py-8 text-center text-muted-foreground"><p>No streams found</p></div>
   </div>
</div>

<script>
  // Re-using logic with updated IDs and Classes
  
  // Toast
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastIconContainer = document.getElementById('toast-icon-container');
    const toastIcon = document.getElementById('toast-icon');
    const toastMessage = document.getElementById('toast-message');

    toast.classList.remove('hidden');
    void toast.offsetWidth;
    toast.classList.remove('translate-y-[-20px]', 'opacity-0');

    if (type === 'success') {
      toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-green-100 text-green-500 dark:bg-green-900/30 dark:text-green-400';
      toastIcon.className = 'ti ti-check';
    } else {
      toastIconContainer.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg bg-red-100 text-red-500 dark:bg-red-900/30 dark:text-red-400';
      toastIcon.className = 'ti ti-alert-circle';
    }

    toastMessage.textContent = message;

    setTimeout(() => {
      toast.classList.add('translate-y-[-20px]', 'opacity-0');
      setTimeout(() => toast.classList.add('hidden'), 300);
    }, 3000);
  }

  // Modal Helpers
  function openModal(id) {
     const modal = document.getElementById(id);
     modal.classList.remove('hidden');
     document.body.style.overflow = 'hidden';
  }
  
  function closeModal(id) {
     // if id is event or null, assume confirm modal by default for backward compat
     const modalId = (typeof id === 'string') ? id : 'confirmModal';
     const modal = document.getElementById(modalId);
     if(modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
     }
  }
  
  // Edit Modal Wrapper
  window.closeEditModal = () => closeModal('editModal');
  window.closeCreateModal = () => closeModal('createModal');
  window.closeVideoModal = () => closeModal('videoModal');
  window.closeStreamModal = () => closeModal('streamModal');

  // ... (Remaining Logic: openEditModal, openCreateModal, fetch logic from original file)
  // For brevity, I will copy the essential logic blocks but adapt the UI manipulation parts.
  
  function openEditModal(userId, username, role, status, avatar) {
    document.getElementById('editUserId').value = userId;
    document.getElementById('editUsername').value = username;
    document.getElementById('editRole').value = role;
    document.getElementById('editStatus').value = status;
    document.getElementById('editPassword').value = '';

    const avatarImg = document.getElementById('editUserAvatar');
    if (avatar && avatar !== 'null') {
      avatarImg.src = `/uploads/avatars/${avatar}`;
    } else {
      avatarImg.src = '/images/default-avatar.jpg';
    }

    openModal('editModal');
  }
  
  function openCreateModal() {
    document.getElementById('createUsername').value = '';
    document.getElementById('createRole').value = 'member';
    document.getElementById('createStatus').value = 'active';
    document.getElementById('createPassword').value = '';
    document.getElementById('createUserAvatar').src = '/images/default-avatar.jpg';
    document.getElementById('createAvatarInput').value = '';
    
    openModal('createModal');
  }
  
  // Expose globally
  window.editUser = function(userId, username, role, status, avatarPath) {
    openEditModal(userId, username, role, status, avatarPath);
  }
  
  window.deleteUser = function(userId, username) {
     document.getElementById('modalTitle').textContent = 'Delete User';
     document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${username}"?`;

     const confirmBtn = document.getElementById('confirmButton');
     // Clone to remove listeners
     const newBtn = confirmBtn.cloneNode(true);
     confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

     newBtn.addEventListener('click', () => {
        fetch('/api/users/delete', {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify({ userId })
        })
        .then(res => res.json())
        .then(d => {
           if(d.success) { showToast('Deleted successfully'); location.reload(); }
           else showToast(d.message, 'error');
        });
        closeModal('confirmModal');
     });

     openModal('confirmModal');
  }
  
  // Image Preview
  ['editAvatarInput', 'createAvatarInput'].forEach(id => {
     document.getElementById(id).addEventListener('change', function(e) {
        if(e.target.files[0]) {
           const reader = new FileReader();
           reader.onload = (ev) => {
              const imgId = id === 'editAvatarInput' ? 'editUserAvatar' : 'createUserAvatar';
              document.getElementById(imgId).src = ev.target.result;
           };
           reader.readAsDataURL(e.target.files[0]);
        }
     });
  });
  
  // Form Submits
  document.getElementById('editUserForm').addEventListener('submit', function(e) {
     e.preventDefault();
     const fd = new FormData(this);
     fetch('/api/users/update', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(d => {
           if(d.success) { showToast('Updated'); location.reload(); }
           else showToast(d.message, 'error');
        });
  });
  
  document.getElementById('createUserForm').addEventListener('submit', function(e) {
     e.preventDefault();
     const fd = new FormData(this);
     fetch('/api/users/create', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(d => {
           if(d.success) { showToast('Created'); location.reload(); }
           else showToast(d.message, 'error');
        });
  });
  
  // Filters
  function filterUsers() {
     const search = document.getElementById('searchInput').value.toLowerCase();
     const role = document.getElementById('roleFilter').value;
     const status = document.getElementById('statusFilter').value;

     const rows = document.querySelectorAll('.user-row');
     let visible = 0;

     rows.forEach(row => {
        const uName = row.dataset.username;
        const uRole = row.dataset.role;
        const uStatus = row.dataset.status;

        const match = uName.includes(search) &&
                      (!role || uRole === role) &&
                      (!status || uStatus === status);

        if(match) {
           row.style.display = '';
           visible++;
        } else {
           row.style.display = 'none';
        }
     });

     document.getElementById('searchEmptyState').classList.toggle('hidden', visible > 0);
  }
  
  document.getElementById('searchInput').addEventListener('input', filterUsers);
  document.getElementById('roleFilter').addEventListener('change', filterUsers);
  document.getElementById('statusFilter').addEventListener('change', filterUsers);
  
  // Show Video/Stream Modals
  window.showVideoModal = function(el) {
     const userId = el.dataset.userId;
     const username = el.dataset.username;
     document.getElementById('videoModalTitle').textContent = `Videos by ${username}`;
     openModal('videoModal');

     const list = document.getElementById('videoList');
     list.innerHTML = '<div class="p-4 text-center text-muted-foreground">Loading...</div>';

     fetch(`/api/users/${userId}/videos`)
        .then(r => r.json())
        .then(data => {
           list.innerHTML = '';
           if(data.success && data.videos.length) {
              document.getElementById('videoEmptyState').classList.add('hidden');
              data.videos.forEach(v => {
                 list.innerHTML += `
                    <div class="flex items-center gap-3 p-3 rounded bg-muted/50 border border-border">
                       <div class="h-10 w-16 bg-muted rounded overflow-hidden shrink-0">
                          <img src="${v.thumbnail_path || ''}" class="h-full w-full object-cover" onerror="this.style.display='none'">
                       </div>
                       <div class="flex-1 min-w-0">
                          <div class="font-medium truncate text-sm">${v.title}</div>
                          <div class="text-xs text-muted-foreground">${formatFileSize(v.file_size)} • ${new Date(v.created_at).toLocaleDateString()}</div>
                       </div>
                    </div>
                 `;
              });
           } else {
              document.getElementById('videoEmptyState').classList.remove('hidden');
           }
        });
  }
  
  window.showStreamModal = function(el) {
     const userId = el.dataset.userId;
     const username = el.dataset.username;
     document.getElementById('streamModalTitle').textContent = `Streams by ${username}`;
     openModal('streamModal');

     const list = document.getElementById('streamList');
     list.innerHTML = '<div class="p-4 text-center text-muted-foreground">Loading...</div>';

     fetch(`/api/users/${userId}/streams`)
        .then(r => r.json())
        .then(data => {
           list.innerHTML = '';
           if(data.success && data.streams.length) {
              document.getElementById('streamEmptyState').classList.add('hidden');
              data.streams.forEach(s => {
                 list.innerHTML += `
                    <div class="flex items-center gap-3 p-3 rounded bg-muted/50 border border-border">
                       <div class="flex-1 min-w-0">
                          <div class="font-medium truncate text-sm">${s.title}</div>
                          <div class="text-xs text-muted-foreground">${s.platform} • ${s.status}</div>
                       </div>
                    </div>
                 `;
              });
           } else {
              document.getElementById('streamEmptyState').classList.remove('hidden');
           }
        });
  }
  
  function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
</script>
